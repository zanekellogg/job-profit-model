<html>
    <head>
        <title>Job Profit Model</title>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.0/papaparse.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/7.8.1/rxjs.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <input type="file" id="file" title="File Input" accept=".csv" />
        
        <div>
            <canvas id="myChart"></canvas>
        </div>

        <pre id="output"></pre>
        <pre id="sampleData" hidden="true">
            [{
                "Job Date": "2024-10-01",
                "Description": "Smith, Basic electric work",
                "Labor": "2340",
                "Materials": "1781",
                "Overhead": "412.1",
                "Amount Received": "5084.34",
                "Original Estimate": "4867.36"
            },
            {
                "Job Date": "2024-10-10",
                "Description": "Williams, Building a deck",
                "Labor": "1170",
                "Materials": "320",
                "Overhead": "149",
                "Amount Received": "2065.32",
                "Original Estimate": "2112.93"
            },
            {
                "Job Date": "2024-10-28",
                "Description": "Garcia, Kitchen remodel",
                "Labor": "850",
                "Materials": "893",
                "Overhead": "206.3",
                "Amount Received": "2179.16",
                "Original Estimate": "2355"
            },
            {
                "Job Date": "2024-10-18",
                "Description": "Jones, Floor installation",
                "Labor": "1755",
                "Materials": "1869",
                "Overhead": "362.4",
                "Amount Received": "4576.73",
                "Original Estimate": "5367.54"
            },
            {
                "Job Date": "2024-11-01",
                "Description": "Martinez, Plumbing repair",
                "Labor": "1755",
                "Materials": "1932",
                "Overhead": "368.7",
                "Amount Received": "5329.24",
                "Original Estimate": "4337.2"
            },
            {
                "Job Date": "2024-11-11",
                "Description": "Wilson, Kitchen remodel",
                "Labor": "1755",
                "Materials": "1812",
                "Overhead": "356.7",
                "Amount Received": "4771.68",
                "Original Estimate": "5653.69"
            },
            {
                "Job Date": "2024-11-18",
                "Description": "Taylor, Plumbing repair",
                "Labor": "2340",
                "Materials": "1789",
                "Overhead": "412.9",
                "Amount Received": "5612.3",
                "Original Estimate": "5435.59"
            },
            {
                "Job Date": "2024-11-28",
                "Description": "White, Bathroom remodel",
                "Labor": "1755",
                "Materials": "501",
                "Overhead": "225.6",
                "Amount Received": "3331.97",
                "Original Estimate": "3451.03"
            },
            {
                "Job Date": "2024-12-09",
                "Description": "Martin, Bathroom remodel",
                "Labor": "1755",
                "Materials": "209",
                "Overhead": "196.4",
                "Amount Received": "2387.84",
                "Original Estimate": "2180.07"
            },
            {
                "Job Date": "2024-12-23",
                "Description": "Young, Basic electric work",
                "Labor": "2925",
                "Materials": "1416",
                "Overhead": "434.1",
                "Amount Received": "5779.8",
                "Original Estimate": "5385.17"
            }]
        </pre>
        <script>
            // Imports
            const { fromEvent } = rxjs;
            const { switchMap, map, tap } = rxjs.operators;

            // Initialization
            const fileInput = document.getElementById("file");
            const output = document.getElementById('output');
            const sampleData = document.getElementById('sampleData');

            // First Load
            var json = JSON.parse(sampleData.innerText);
            var transformedData = transformData(json);
            showData(transformedData);

            // Event Streams
            const fileInputChange$ = fromEvent(fileInput, 'change');

            // Transformations

            // *** Helper Functions
            function transformData(data) {
                
                var highestLabor = 0;
                data.forEach(e => {
                    const labor = parseFloat(e["Labor"]);
                    highestLabor = (labor > highestLabor) ? labor : highestLabor;
                });
                const laborDivider = highestLabor / 3;
                
                return data.map(entry => {
                    const jobDateUtc = Date.parse(entry["Job Date"]);
                    const jobDate = new Date(jobDateUtc);
                    const description = entry.Description;
                    const labor = parseFloat(entry["Labor"] || 0);
                    const materials = parseFloat(entry["Materials"] || 0);
                    const overhead = parseFloat(entry["Overhead"] || 0);
                    const amountRecieved = parseFloat(entry["Amount Received"] || 0);
                    const originalEstimate = parseFloat(entry["Original Estimate"] || 0);

                    // Profit
                    var profit = amountRecieved - labor - materials - overhead;
                    profit = parseFloat(profit.toFixed(2));

                    // Profit Percent
                    var profitPercent = profit / amountRecieved;
                    profitPercent = parseFloat(profitPercent.toFixed(4));

                    // Estimate Variance
                    var variance = amountRecieved - originalEstimate;
                    variance = parseFloat(variance.toFixed(2));

                    // Estimate Variance Percent
                    var variancePercent = variance / originalEstimate;
                    variancePercent = parseFloat(variancePercent.toFixed(4));

                    // Month & Year
                    const monthNumber = jobDate.getMonth() + 1;
                    const year = jobDate.getFullYear();
                    const monthLabels = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                    const monthLabel = monthLabels[jobDate.getMonth()];
                    const dateLabel = monthLabel + "-" + year;

                    // Labor Group
                    var laborGroup = "S";
                    if (labor >= laborDivider && labor < (laborDivider * 2)) {
                        laborGroup = "M";
                    } else if (labor >= (laborDivider * 2)) {
                        laborGroup = "L";
                    }

                    return {
                        jobDate,
                        description,
                        labor,
                        materials,
                        overhead,
                        amountRecieved,
                        originalEstimate,
                        profit,
                        profitPercent,
                        variance,
                        variancePercent,
                        monthNumber,
                        year,
                        monthLabel,
                        dateLabel,
                        laborGroup
                    }
                });
            }

            function showData(transformedData) {
                console.log(transformedData);
                output.textContent = JSON.stringify(transformedData, null, 2);
            }

            // File input changed
            fileInputChange$.pipe(
                // Step 1: Read the file
                switchMap(event => {
                    const file = event.target.files[0];
                    if (!file) {
                        return rxjs.EMPTY;
                    }

                    return new Promise((resolve, reject) => {
                        Papa.parse(file, {
                            header: true, // Convert rows to objects using the headers as keys
                            skipEmptyLines: true,
                            complete: (results) => resolve(results.data),
                            error: (error) => reject(error)
                        });                            
                    })
                }),
                // Step 2: Transform
                map(parsedData => {
                    return transformData(parsedData);
                })
            ).subscribe({
                next: transformedData => {
                    showData(transformedData);
                },
                error: err => console.error("Error: ", err),
                complete: () => console.log("Processing Complete")
            });
        </script>
    </body>
</html>